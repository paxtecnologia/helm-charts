apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ printf "%s-%s" (include "pax-prometheus.fullname" .) "pax-pod-memory.rules" | trunc 63 | trimSuffix "-" }}
  namespace: {{ template "pax-prometheus.namespace" . }}
  labels:
    app: {{ template "kube-prometheus-stack.name" . }}
{{ include "kube-prometheus-stack.labels" . | indent 4 }}
{{- if .Values.defaultRules.labels }}
{{ toYaml .Values.defaultRules.labels | indent 4 }}
{{- end }}
{{- if .Values.defaultRules.annotations }}
  annotations:
{{ toYaml .Values.defaultRules.annotations | indent 4 }}
{{- end }}
spec:
  groups:
  - name: k8s.rules.pod_memory
    rules:
    # 1. Alerta para Pods Finalizados por OOM
    - alert: PodOOMKilled
      expr: kube_pod_container_status_last_terminated_reason{job="kube-state-metrics", reason="OOMKilled"} == 1
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Pod finalizado por OOM (Out of Memory)"
        description: "O container {{`{{`}} $labels.container {{`}}`}} no pod {{`{{`}} $labels.pod {{`}}`}} (namespace: {{`{{`}} $labels.namespace {{`}}`}}) foi finalizado por OOMKilled. Workload: {{`{{`}} $labels.owner_kind {{`}}`}}/{{`{{`}} $labels.owner_name {{`}}`}}"
    
    # 2. Alerta para Subutilização de Memória (vs Request)
    - alert: PodMemoryRequestUnderutilized
      expr: |
        sum(container_memory_working_set_bytes{job="kubelet", metrics_path="/metrics/cadvisor", container!="", image!=""}) by (namespace, pod, container)
        /
        sum(kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory", unit="byte"} > 0) by (namespace, pod, container)
        < 0.80
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "Subutilização de memória (request muito alto)"
        description: |-
          Container {{`{{`}} $labels.container {{`}}`}} (pod: {{`{{`}} $labels.pod {{`}}`}}, ns: {{`{{`}} $labels.namespace {{`}}`}}) 
          está usando apenas {{`{{`}} printf "%.1f" (value * 100) {{`}}`}}% do memory request.
          Workload: {{`{{`}} $labels.owner_kind {{`}}`}}/{{`{{`}} $labels.owner_name {{`}}`}}
          Considere reduzir os requests e limits para otimizar recursos.

    # 3. Alerta para Uso Alto de Memória (vs Limit) - NOVO
    - alert: PodMemoryUsageNearLimit
      expr: |
        sum(container_memory_working_set_bytes{job="kubelet", metrics_path="/metrics/cadvisor", container!="", image!=""}) by (namespace, pod, container)
        /
        sum(kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory", unit="byte"} > 0) by (namespace, pod, container)
        > 0.96
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Uso de memória próximo ao limite (96%)"
        description: |-
          Container {{`{{`}} $labels.container {{`}}`}} (pod: {{`{{`}} $labels.pod {{`}}`}}, ns: {{`{{`}} $labels.namespace {{`}}`}})
          está usando {{`{{`}} printf "%.1f" (value * 100) {{`}}`}}% do memory limit.
          Workload: {{`{{`}} $labels.owner_kind {{`}}`}}/{{`{{`}} $labels.owner_name {{`}}`}}
          Risco de OOMKilled. Considere aumentar o limit ou otimizar a aplicação.